!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).EmbedSDK=n()}(this,(function(){"use strict";function e(e,n,t,o){return new(t||(t=Promise))((function(i,r){function a(e){try{d(o.next(e))}catch(e){r(e)}}function s(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,s)}d((o=o.apply(e,n||[])).next())}))}function n(e,n){var t,o,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function s(r){return function(s){return function(r){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,o&&(i=2&r[0]?o.return:r[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,r[1])).done)return i;switch(o=0,i&&(r=[2&r[0],i.value]),r[0]){case 0:case 1:i=r;break;case 4:return a.label++,{value:r[1],done:!1};case 5:a.label++,o=r[1],r=[0];continue;case 7:r=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==r[0]&&2!==r[0])){a=0;continue}if(3===r[0]&&(!i||r[1]>i[0]&&r[1]<i[3])){a.label=r[1];break}if(6===r[0]&&a.label<i[1]){a.label=i[1],i=r;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(r);break}i[2]&&a.ops.pop(),a.trys.pop();continue}r=n.call(e,a)}catch(e){r=[6,e],o=0}finally{t=i=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,s])}}}var t="https://subhranshudas.github.io/embed-dapp-poc",o="https://backend-kovan.epns.io/apis/feeds/get_feeds",i="EPNS_SDK_EMBED_VIEW_ROOT",r="EPNS_SDK_STYLE_TAG_ID_",a="EPNS_SDK_EMBED_IFRAME",s={ZINDEX_MAX:2147483638},d="EPNS_SDK_IFRAME_TO_PARENT_MSG",c="EPNS_SDK_LOCAL_STORAGE_";function p(e){return e.appName?i+"_"+(void 0===(n=e.appName)&&(n=""),n.toUpperCase()):i+"_DEFAULT_APPNAME";var n}function l(t){return e(this,void 0,void 0,(function(){var e;return n(this,(function(n){e=window.localStorage.getItem(t);try{return[2,JSON.parse(e)]}catch(e){return console.warn("[EPNS-SDK] - local storage read issue"),[2,""]}return[2]}))}))}return{config:{isInitialized:!1,isFrameVisible:!1,targetID:"epns-sdk-trigger-id",appName:"appName",viewOptions:{headerText:"Notifications",type:"sidebar",showUnreadIndicator:!1,unreadIndicatorColor:"#cc1919",unreadIndicatorPosition:"top-right",theme:"light"},user:"0xD8634C39BBFd4033c0d3289C4515275102423681"},init:function(e){this.config.isInitialized||(this.config=e,this.config.isInitialized=!0,this.setUpWidget(),this.insertCSS(),this.handleUnreadNotifications(),console.info("[EPNS-SDK] CONFIG set",this.config))},setUpWidget:function(){var e=this;"complete"===document.readyState?e.setUpEventHandlers():window.addEventListener("load",(function(){e.setUpEventHandlers()})),window.addEventListener("message",(function(n){try{if("string"==typeof n.data){var t=JSON.parse(n.data);t&&t.msgCode===d&&(console.info("Received communication from the IFRAME: ",t),"IFRAME_APP_LOADED"===t.msgType&&e.publishMessageToIFRAME({msg:e.config,msgCode:"EPNS_SDK_PARENT_TO_IFRAME_MSG",msgType:"SDK_CONFIG_INIT"}),"IFRAME_APP_CLOSE"===t.msgType&&e.hideEmbedView())}}catch(e){console.error("something went wrong parsing IFRAME message to the APP.",e)}}),!1)},setUpEventHandlers:function(){var e=this,n=document.querySelector("#"+e.config.targetID);n&&n.id===e.config.targetID?(console.info("[EPNS-SDK - click handler attached to the #"+e.config.targetID+" ]"),n.addEventListener("click",(function(n){n.preventDefault(),n.stopPropagation(),e.showEmbedView()}))):console.error("Did not find the trigger element "+e.config.targetID)},hideEmbedView:function(){var e,n=p(this.config),t=document.querySelector("#"+n);t&&(null===(e=document.querySelector("body"))||void 0===e||e.removeChild(t))},showEmbedView:function(){var e=this,n=p(e.config),o=document.createElement("div");o.id=n,o.classList.add("epns-sdk-embed-modal","epns-sdk-embed-modal-open"),o.innerHTML=(e.config,'\n        <div class="epns-sdk-embed-modal-overlay">\n            <div class="epns-sdk-embed-modal-content">\n                <iframe id="'+a+'" src="'+t+'"></iframe>\n            </div>\n        </div>\n    '),document.querySelector("body").appendChild(o),e.removeUnreadIndicatorElement();var i="#"+n+" .epns-sdk-embed-modal-overlay";document.querySelector(i).onclick=function(n){n.preventDefault(),n.stopPropagation(),e.hideEmbedView()}},publishMessageToIFRAME:function(e){var n=e.msg,t=e.msgType,o=e.msgCode,i=document.querySelector("iframe#"+a);try{i.contentWindow.postMessage(JSON.stringify({msgCode:o,msgType:t,msg:n}),"*")}catch(e){console.error("[EPNS-SDK] - issue publishing message to IFRAME")}},insertCSS:function(){var e=p(this.config),n=""+r+e,t=document.querySelector("style#"+n);if(!t){var o=document.createElement("style");o.id=""+n,t=o}t.innerHTML=function(e){e.viewOptions.theme;var n=e.viewOptions.type||"sidebar",t=p(e);return"\n        #"+t+".epns-sdk-embed-modal {\n          display: none; /* Hidden by default */\n          transition: display 0.5s ease-in-out;\n        }\n\n        #"+t+".epns-sdk-embed-modal.epns-sdk-embed-modal-open {\n          display: block;\n          position: absolute;\n          left: 0;\n          top: 0;\n          right: 0;\n          bottom: 0;\n          z-index: "+(s.ZINDEX_MAX-2)+";\n        }\n\n        #"+t+" .epns-sdk-embed-modal-overlay {\n          position: absolute;\n          top: 0;\n          right: 0;\n          left: 0;\n          bottom: 0;\n          background-color: #000000bf;\n          z-index: "+(s.ZINDEX_MAX-2)+";\n        }\n\n        #"+t+" .epns-sdk-embed-modal-content {\n          position: relative;\n          width: 100%;\n          height: 100%;\n          z-index: "+s.ZINDEX_MAX+";\n        }\n\n        #"+t+" .epns-sdk-embed-modal-content iframe#"+a+" {\n          "+("sidebar"===n?"width: 450px;":"width: 100%;")+"\n          height: 100%;\n          border-radius: 8px;\n          overflow: hidden;\n          border: none;\n          position: absolute;\n          right: 0;\n          top: 0;\n          bottom: 0;\n        }  \n\n        #"+e.targetID+" {\n            position: relative;\n        }\n\n\n        /* UNREAD INDICATOR STYLES  */\n        #"+e.targetID+" .epns-sdk-unread-indicator.epns-sdk-appname-"+e.appName+" {\n            position: absolute;\n            display: block;\n            width: 20px;\n            height: 20px;\n            border-radius: 50%;\n            background: "+e.viewOptions.unreadIndicatorColor+";\n            box-shadow: 0 0 0 "+e.viewOptions.unreadIndicatorColor+";\n            animation: epnsSdkPulse-"+e.appName+" 2s infinite;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 10px;\n            color: #fff;\n          }\n  \n          #"+e.targetID+" .epns-sdk-unread-indicator.epns-sdk-appname-"+e.appName+".top-right {\n            right: -10px;\n            top: -10px;\n          }\n  \n          #"+e.targetID+" .epns-sdk-unread-indicator.epns-sdk-appname-"+e.appName+".top-left {\n            left: -10px;\n            top: -10px;\n          }\n  \n          #"+e.targetID+" .epns-sdk-unread-indicator.epns-sdk-appname-"+e.appName+".bottom-left {\n            bottom: -10px;\n            left: -10px;\n          }\n          #"+e.targetID+" .epns-sdk-unread-indicator.epns-sdk-appname-"+e.appName+".bottom-right {\n            bottom: -10px;\n            right: -10px;\n          }\n  \n          @-webkit-keyframes epnsSdkPulse-"+e.appName+" {\n            0% {\n              -webkit-box-shadow: 0 0 0 0 "+e.viewOptions.unreadIndicatorColor+";\n            }\n            70% {\n                -webkit-box-shadow: 0 0 0 10px #0000;\n            }\n            100% {\n                -webkit-box-shadow: 0 0 0 0 #0000;\n            }\n          }\n          @keyframes epnsSdkPulse-"+e.appName+" {\n            0% {\n              -moz-box-shadow: 0 0 0 0 "+e.viewOptions.unreadIndicatorColor+";\n              box-shadow: 0 0 0 0 "+e.viewOptions.unreadIndicatorColor+";\n            }\n            70% {\n                -moz-box-shadow: 0 0 0 10px #0000;\n                box-shadow: 0 0 0 10px #0000;\n            }\n            100% {\n                -moz-box-shadow: 0 0 0 0 #0000;\n                box-shadow: 0 0 0 0 #0000;\n            }\n          }\n    "}(this.config),document.querySelector("head").appendChild(t)},handleUnreadNotifications:function(){var e=this;e.config.viewOptions.showUnreadIndicator?e.refreshUnreadCount():e.removeUnreadIndicatorElement()},refreshUnreadCount:function(){return e(this,void 0,void 0,(function(){var e,t,o,i,r,a,s,d,u;return n(this,(function(n){switch(n.label){case 0:return e=this,t=0,o=p(this.config),[4,l(i=""+c+o+"_LAST_NOTIFICATIONS")];case 1:return r=n.sent(),[4,e.getUnreadNotifications()];case 2:return a=(a=n.sent()).map((function(e){return e.payload_id})),console.log({lastNotifications:r,latestNotifications:a}),h=r,(s=Array.isArray(h)?h[0]:null)?-1!==(d=a.indexOf(s))&&(u=a.slice(0,d),t=u.length):t=a.length,f=i,m=a,window.localStorage.setItem(f,JSON.stringify(m)),t>0?e.addUnreadIndicatorElement(t>9?"9+":t):e.removeUnreadIndicatorElement(),[2]}var f,m,h}))}))},getUnreadNotifications:function(){return e(this,void 0,void 0,(function(){var e,t;return n(this,(function(n){switch(n.label){case 0:e=this.config.user,n.label=1;case 1:return n.trys.push([1,6,,7]),[4,fetch(o,{method:"POST",body:JSON.stringify({user:e,page:1,pageSize:10,op:"read"}),headers:{"Content-type":"application/json; charset=UTF-8"}})];case 2:return(t=n.sent()).ok?[4,t.json()]:[3,4];case 3:return[2,n.sent().results||[]];case 4:return[2,[]];case 5:return[3,7];case 6:return n.sent(),console.error("[EPNS_SDK_EMBED] - error while calling "+o),[2,[]];case 7:return[2]}}))}))},addUnreadIndicatorElement:function(e){this.removeUnreadIndicatorElement();var n=document.createElement("div");n.classList.add("epns-sdk-unread-indicator","epns-sdk-appname-"+this.config.appName,this.config.viewOptions.unreadIndicatorPosition),n.innerText=e,document.querySelector("#"+this.config.targetID)&&document.querySelector("#"+this.config.targetID).appendChild(n)},removeUnreadIndicatorElement:function(){document.querySelector("#"+this.config.targetID)&&document.querySelector("#"+this.config.targetID).querySelector(".epns-sdk-unread-indicator.epns-sdk-appname-"+this.config.appName)&&document.querySelector("#"+this.config.targetID).removeChild(document.querySelector("#"+this.config.targetID).querySelector(".epns-sdk-unread-indicator.epns-sdk-appname-"+this.config.appName))},cleanUp:function(){}}}));
